name: Build And Push ECR Images

on:
  push:
    branches:
      - develop
    paths:
      - ".github/workflows/build-and-push-ecr.yml"
      - "Dockerfile"
      - ".dockerignore"
      - "deploy/k8s/**"
      - "go.mod"
      - "go.sum"
      - "pkg/**"
      - "services/**"
  workflow_dispatch:

concurrency:
  group: build-and-promote-develop
  cancel-in-progress: true

permissions:
  contents: read
  id-token: write

jobs:
  build-and-push:
    name: Build And Push Service Images
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        service:
          - api-gateway
          - orders
          - notifications
          - worker

    env:
      AWS_REGION: us-east-1
      ECR_REGISTRY: "971146591534.dkr.ecr.us-east-1.amazonaws.com"
      ECR_REPOSITORY_PREFIX: triad-app

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Derive image tags
        id: tags
        shell: bash
        run: |
          set -euo pipefail
          short_sha="${GITHUB_SHA::12}"
          echo "short_sha=${short_sha}" >> "${GITHUB_OUTPUT}"

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: "arn:aws:iam::971146591534:role/github-actions-triad-app-ecr-push"

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push immutable image
        uses: triad-platform/triad-ci-security/reusable-actions/build-image@main
        with:
          image: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY_PREFIX }}-${{ matrix.service }}:${{ matrix.service }}-sha-${{ steps.tags.outputs.short_sha }}
          context: .
          dockerfile: Dockerfile
          push: 'true'
          build_args: |
            SERVICE=${{ matrix.service }}

      - name: Build and push branch-sha tag
        uses: triad-platform/triad-ci-security/reusable-actions/build-image@main
        with:
          image: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY_PREFIX }}-${{ matrix.service }}:${{ matrix.service }}-${{ github.ref_name }}-${{ steps.tags.outputs.short_sha }}
          context: .
          dockerfile: Dockerfile
          push: 'true'
          build_args: |
            SERVICE=${{ matrix.service }}

      - name: Build and push branch tag
        uses: triad-platform/triad-ci-security/reusable-actions/build-image@main
        with:
          image: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY_PREFIX }}-${{ matrix.service }}:${{ matrix.service }}-${{ github.ref_name }}
          context: .
          dockerfile: Dockerfile
          push: 'true'
          build_args: |
            SERVICE=${{ matrix.service }}

  promote-dev-manifests:
    name: Promote GitOps Overlay To Image Digests
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/develop'
    env:
      AWS_REGION: us-east-1
      ECR_REGISTRY: "971146591534.dkr.ecr.us-east-1.amazonaws.com"
      ECR_REPOSITORY_PREFIX: triad-app
      GITOPS_REPO: triad-platform/triad-kubernetes-platform
      GITOPS_REF: develop
      GITOPS_PATH: workloads/pulsecart/dev/kustomization.yaml
    steps:
      - name: Checkout app repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Checkout GitOps repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.GITOPS_REPO }}
          ref: ${{ env.GITOPS_REF }}
          token: ${{ secrets.TRIAD_PLATFORM_GITOPS_PAT }}
          path: gitops-platform

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: "arn:aws:iam::971146591534:role/github-actions-triad-app-ecr-push"

      - name: Update GitOps overlay image digests
        shell: bash
        run: |
          set -euo pipefail
          short_sha="${GITHUB_SHA::12}"
          tag_suffix="develop-${short_sha}"

          api_gateway_digest="$(aws ecr describe-images \
            --region "${AWS_REGION}" \
            --repository-name "${ECR_REPOSITORY_PREFIX}-api-gateway" \
            --image-ids imageTag="api-gateway-${tag_suffix}" \
            --query 'imageDetails[0].imageDigest' \
            --output text)"
          orders_digest="$(aws ecr describe-images \
            --region "${AWS_REGION}" \
            --repository-name "${ECR_REPOSITORY_PREFIX}-orders" \
            --image-ids imageTag="orders-${tag_suffix}" \
            --query 'imageDetails[0].imageDigest' \
            --output text)"
          notifications_digest="$(aws ecr describe-images \
            --region "${AWS_REGION}" \
            --repository-name "${ECR_REPOSITORY_PREFIX}-notifications" \
            --image-ids imageTag="notifications-${tag_suffix}" \
            --query 'imageDetails[0].imageDigest' \
            --output text)"
          worker_digest="$(aws ecr describe-images \
            --region "${AWS_REGION}" \
            --repository-name "${ECR_REPOSITORY_PREFIX}-worker" \
            --image-ids imageTag="worker-${tag_suffix}" \
            --query 'imageDetails[0].imageDigest' \
            --output text)"

          overlay="gitops-platform/${GITOPS_PATH}"
          perl -0pi -e 's|^# triad-app source revision: .*$|# triad-app source revision: '"${GITHUB_SHA}"'|m' "${overlay}"
          perl -0pi -e 's|(newName: 971146591534\.dkr\.ecr\.us-east-1\.amazonaws\.com/triad-app-api-gateway\n\s+)(?:newTag|digest): [^\n]+|\1digest: '"${api_gateway_digest}"'|g' "${overlay}"
          perl -0pi -e 's|(newName: 971146591534\.dkr\.ecr\.us-east-1\.amazonaws\.com/triad-app-orders\n\s+)(?:newTag|digest): [^\n]+|\1digest: '"${orders_digest}"'|g' "${overlay}"
          perl -0pi -e 's|(newName: 971146591534\.dkr\.ecr\.us-east-1\.amazonaws\.com/triad-app-notifications\n\s+)(?:newTag|digest): [^\n]+|\1digest: '"${notifications_digest}"'|g' "${overlay}"
          perl -0pi -e 's|(newName: 971146591534\.dkr\.ecr\.us-east-1\.amazonaws\.com/triad-app-worker\n\s+)(?:newTag|digest): [^\n]+|\1digest: '"${worker_digest}"'|g' "${overlay}"

      - name: Commit GitOps promotion
        shell: bash
        run: |
          set -euo pipefail
          cd gitops-platform

          if git diff --quiet -- "${GITOPS_PATH}"; then
            echo "No GitOps overlay changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "${GITOPS_PATH}"
          git commit -m "ci: promote pulsecart digests for ${GITHUB_SHA::12}"
          git push origin HEAD:"${GITOPS_REF}"
